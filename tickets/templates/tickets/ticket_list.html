{% extends "../base.html" %}
{% block css %}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
{% endblock css %}
{% block content %}
    {% if filterset %}
    <form action="" method="get" class="filterset_form">
        {{ filterset.form.as_p }}
        <input type="submit" />
    </form>
    {% endif %}
    {% if ticket_list %}
    <table class="table cell-border stripe hover" id="ticket_list">
        <thead>
            <th></th>
            <th>Заголовок</th>
            <th>От кого</th>
            <th>Дата создания</th>
            <th>Приоритет</th>
            <th>Срок</th>
            <th>Статус</th>
            <th>Осталось</th>
        </thead>
        <tbody>
            {% for ticket in ticket_list %}
            <tr data-description="{{ ticket.description }}">
                <td class="details-control"></td>
                <td><a href="{{  ticket.get_absolute_url }}">{{ ticket.title }}</a></td>
                <td>{{ ticket.creator }}</td>
                <td align="center">{{ ticket.date_create|date:"d.m.y" }}</td>
                <td class="{{ ticket.priority_css }}">{{ ticket.priority_text }}</td>
                <td class="{{ ticket.deadline_css }}">{{ ticket.verbose_deadline_status }}</td>
                <td class="{{ ticket.status_css }}">{{ ticket.status_text }}</td>
                <td>{{ ticket.days_left }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        Заявок пока нет
    {% endif %}
{% endblock content %}  
{% block js%}
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script>
    // ToDo форматирование можно улучшить
    function format_child_row(value) {
        return '<div><b>Описание проблемы:</b><br> ' + value + '</div>'
    }

    $.fn.dataTable.ext.type.order['priority-pre'] = function ( p ) {
        switch ( p ) {
            case 'Обычный':     return 1;
            case 'Средний':     return 2;
            case 'Высокий':     return 3;
            case 'Срочный':     return 4;
            case 'Критический': return 5;
        }
        return 0;
    };
   
    $(document).ready(() => {
        var table = $('#ticket_list').DataTable({
            'columnDefs': [
                {name: 'Noname', width: '25px', searchable: false, targets: 0},
                {name: 'title', searchable: true, targets: 1},
                {name: 'creator', searchable: false, targets: 2},
                {name: 'dateCreate', searchable: false, targets: 3},
                {name: 'priority', type:'priority', searchable: false, targets: 4},
                {name: 'deadline', orderData: [7], searchable: false, targets: 5},
                {name: 'status', searchable: false, targets: 6},
                {name: 'daysLeft', searchable: false, targets: 7, visible: false},
            ],
            'lengthMenu': [ [1, 50, 100, -1], [1, 50, 100, 'Все'] ],
            'bInfo' : false,
            'language': {
                'paginate':{
                    'next': 'Вперёд',
                    'previous': 'Назад'
                },
                'sSearch': 'Поиск по названию',
                'lengthMenu': 'Показывать _MENU_ записей',
            }
        });

        $('#ticket_list').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row(tr);
            if (row.child.isShown()) {
                row.child.hide();
                tr.removeClass('shown');
            } else {
                row.child(format_child_row(tr.data('description'))).show();
                tr.addClass('shown');
            }
        });
    })
</script>
{% endblock js%}
